---
- name: test - local setup
  hosts: 127.0.0.1
  gather_facts: false
  tasks:
    - name: Download current linux-system-roles.selinux
      git:
        repo: https://github.com/linux-system-roles/selinux/
        dest: roles/linux-system-roles.selinux
        version: master
        depth: 1
      become: false
      # skip this for RHEL downstream tests, which define $BEAKERLIB
      when:
        - lookup('env', 'BEAKERLIB') | length == 0
        - not 'roles/linux-system-roles.selinux' is exists

- name: Test cockpit_port option
  hosts: all
  gather_facts: true
  tasks:
    - name: tests
      block:
        - name: Run cockpit role
          include_role:
            name: linux-system-roles.cockpit
          vars:
            cockpit_packages: minimal
            cockpit_port: 443

        - meta: flush_handlers

        - name: test - cockpit works on customized port
          get_url:
            dest: /run/out
            url: https://localhost
            validate_certs: no

        - name: test - HTTP response is something sensible
          command: grep 'id="login-user-input"' /run/out

        - name: test - cockpit does not listen on port 9090
          get_url:
            dest: /run/out
            url: https://localhost:9090
            validate_certs: no
          register: result
          failed_when: result is succeeded

        - name: test - clean up output file
          file:
            path: /run/out
            state: absent

      always:
        - include_tasks: tasks/cleanup.yml
