---
- name: Cleanup - packages
  package:
    name:
      # everything else depends on one of these two, so will be removed along
      - cockpit-bridge
      - cockpit-ws
      - cockpit-doc
    state: absent
  when: not __cockpit_is_ostree | d(false)
  tags:
    - always
    - tests::cleanup

- name: Cleanup - services
  service:
    name: "{{ __cockpit_daemon }}"
    state: stopped
    enabled: false
  when: __cockpit_is_ostree | d(false)
  tags:
    - always
    - tests::cleanup

- name: Cleanup - certificates
  when: __test_cert_files | d([]) | length > 0
  block:
    - name: Cleanup - stop tracking certificates
      command: getcert stop-tracking -f {{ item }}
      changed_when: false
      with_items: "{{ __test_cert_files }}"
      register: __cockpit_stop_tracking
      failed_when:
        - __cockpit_stop_tracking is failed
        - "'stdout' in __cockpit_stop_tracking"
        - not __cockpit_stop_tracking.stdout is
          search("No request found that matched arguments")
      tags:
        - always
        - tests::cleanup

    - name: Cleanup - remove certificate and key files
      file:
        path: "{{ item }}"
        state: absent
      with_items: "{{ __test_cert_files + __test_key_files }}"
      tags:
        - always
        - tests::cleanup

- name: Cleanup - config file
  file:
    path: /etc/cockpit/cockpit.conf
    state: absent
  tags:
    - always
    - tests::cleanup

- name: Cleanup - port customization
  file:
    path: /etc/systemd/system/cockpit.socket.d/
    state: absent
  tags:
    - always
    - tests::cleanup

- name: Cleanup - Reload systemd
  systemd:
    daemon_reload: true
  tags:
    - always
    - tests::cleanup
