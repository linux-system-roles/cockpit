---
- name: Test role with default options
  hosts: all
  gather_facts: false
  roles:
    - linux-system-roles.cockpit

  tasks:
    - name: tests
      block:
        - name: test - socket is active  # noqa 303 command-instead-of-module
          command: systemctl is-active {{ __cockpit_daemon }}
          changed_when: false

        - name: test - socket is enabled  # noqa 303 command-instead-of-module
          command: systemctl is-enabled {{ __cockpit_daemon }}
          changed_when: false

        - name: Show sockets
          command: ss -lntp

        - name: test - cockpit works with TLS
          get_url:
            dest: /run/out
            url: https://localhost:9090
            validate_certs: no

        - name: test - HTTP response is something sensible
          command: grep 'id="login-user-input"' /run/out

        - name: test - clean up output file
          file:
            path: /run/out
            state: absent

        - name: test - no configuration file
          stat:
            path: /etc/cockpit/cockpit.conf
          register: result
          failed_when: result.stat.exists

        - name: test - no port configuration file
          stat:
            path: /etc/systemd/system/cockpit.socket.d
          register: result
          failed_when: result.stat.exists

      always:
        - include_tasks: tasks/cleanup.yml
